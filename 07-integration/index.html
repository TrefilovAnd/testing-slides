<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Unit</title>

    <link rel="stylesheet" href="../css/reveal.css">
    <link rel="stylesheet" href="../css/theme/yandex.css">
    <link rel="stylesheet" href="../css/user.css">
    <link rel="stylesheet" href="../css/zenburn.css">
</head>
<body>
<div class="reveal"><div class="slides">

<section>
    <h1>Автотесты</h1>
    <p>Sinon fake timer. Интеграционные тесты. Supertest. Тестирование в браузере</p>
    <p class="author">Жигалов Сергей</p>
</section>

<section>
    <section>
        <h3>Управление временем</h3>
    </section>

    <section>
        <blockquote>
            ... Сделать из твитов бегущую строку. Для этого нужно выводить на
            консоль по одному символу раз в 100ms.
        </blockquote>
    </section>

    <section>
        <h3><code>setTimeout</code></h3>
        <pre class="js"><code data-trim>
setTimeout(() => {
    console.log('Прошла секунда');
}, 1000);
        </code></pre>
    </section>

    <section>
        <h3><code>console.log</code></h3>
        <pre class="js"><code data-trim>
console.log('Несколько');
console.log('строк');
        </code></pre>
        <pre class="console"><code data-trim>
Несколько
строк
        </code></pre>
    </section>

    <section>
        <h3><code>process.stdout.write</code></h3>
        <pre class="js"><code data-trim>
process.stdout.write('Одна');
process.stdout.write('строка');
        </code></pre>
        <pre class="console"><code data-trim>
Однастрока
        </code></pre>
    </section>

    <section>
        <h3>Решение</h3>
        <pre class="js"><code data-trim>
// crawline.js

function crawline(text, cb) {
    const letters = text.split('');

    function print() {
        if (!letters.length) return cb();

        process.stdout.write(letters.shift());
        setTimeout(print, 100);
    }
    print();
}
        </code></pre>
    </section>

    <section>
        <h3>Тест</h3>
        <pre class="js"><code data-trim>
// tests/crawline-test.js

const crawline = require('../crawline');

describe('Crawline', () => {
    it('shoult ptint text', done => {
        crawline('I don’t always bend time and ' +
            'space in unit tests, but when I do, ' +
            'I use Buster.JS + Sinon.JS', done);
    });
});
        </code></pre>
    </section>

    <section>
        <h3><code>npm test</code></h3>
        <img src="images/setTimeoutFailed.gif" alt="setTimeoutFailed" class="fragment">
    </section>

    <section>
        <h3><code>npm test -- --timeout=30000</code></h3>
        <img src="images/setTimeoutLong.gif" alt="setTimeoutLong" class="fragment">
    </section>
</section>

<section>
    <section>
    <h3>Faking time</h3>
        <pre class="js"><code data-trim>
beforeEach(() => clock = sinon.useFakeTimers());
afterEach(() => {
    clock.restore();
    process.stdout.write.restore();
});
        </code></pre>
    </section>

    <section>
        <pre class="js"><code data-trim>
it('shoult ptint text', done => {
    const write = sinon.spy(process.stdout, 'write');

    crawline('I don’t always bend time and ' +
        'space in unit tests, but when I do, ' +
        'I use Buster.JS + Sinon.JS', () => {
            assert.equal(write.callCount, 91);
            done();
        });

    clock.tick(10000);
});
        </code></pre>
    </section>
</section>

<section>
    <section>
        <h3>Интеграционные тесты</h3>
    </section>

    <section
        data-background-image='images/pyramid.png'
        data-background-size='contain'
        data-background-color='#e7e8e9'>
    </section>

    <section>
        <img src="images/bricks.jpg" alt="bricks">
    </section>

    <section>
        <h3><span class="gray">Интеграционные тесты</span> Poker</h3>
        <pre class="js"><code data-trim>
// poker.js
const playPoker = require('./playPoker');

function poker(firstDice, secondDice) {
    try {
        const result = playPoker(firstDice, secondDice);

        console.log(result);
    } catch(error) {
        console.error(error.message);
    }
}
        </code></pre>
    </section>

    <section>
        <h3><span class="gray">Интеграционные тесты</span> Poker</h3>
        <pre class="js size-XS"><code data-trim data-noescape>
// tests/poker-test.js
it('should print success result', () => {
    const log = sinon.stub(console, 'log');
    const error = sinon.stub(console, 'error');

    <span class="fragment fade-out">const playPoker = sinon.stub();
    playPoker.withArgs([1, 2, 3, 4, 5], [1, 2, 3, 4, 6]).returns('Ничья');
    const poker = proxyquire('../poker', { './playPoker': playPoker });</span>

    poker([1, 2, 3, 4, 5], [1, 2, 3, 4, 6]);

    assert(log.calledOnce);
    assert(log.calledWith('Ничья'));
    assert(!error.called);
});
        </code></pre>
    </section>

    <section>
        <h3><span class="gray">Интеграционные тесты</span> Weather</h3>
        <pre class="js size-XS"><code data-trim data-noescape>
// tests/weather-test.js

it('should print temperature', done => {
    <span class="fragment fade-out">nock('https://api.weather.yandex.ru')
        .get('/v1/forecast')
        .reply(200, '{"fact":{"temp":25}}');</span>

    weather((error, actual) => {
        <span class="fragment grow">assert.equal(actual, 25);</span>
        done(error);
    });
});
        </code></pre>
    </section>

    <section>
        <h3><span class="gray">Интеграционные тесты</span> Weather</h3>
        <pre class="js size-XS"><code data-trim data-noescape>
// tests/weather-test.js

it('should print temperature', done => {




    weather((error, actual) => {
        assert(Number.isInteger(actual));
        done(error);
    });
});
        </code></pre>
    </section>
</section>

</div></div>

<script src="../js/head.min.js"></script>
<script src="../js/reveal.js"></script>

<script>
// More info https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
    controls: false,
    slideNumber: 'c',
    history: true,
    margin: 0,
    width: 960,
    height: 700,

    // More info https://github.com/hakimel/reveal.js#dependencies
    dependencies: [
        { src: '../plugin/notes/notes.js', async: true },
        { src: '../plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
    ]
});
</script>
</body>
</html>
